#!/usr/bin/env bash

# Design System Verification Script
# This script verifies that all components are properly configured

set -e

echo "========================================="
echo "  Cornerstone Design System Verification"
echo "========================================="
echo ""

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

pass_count=0
fail_count=0

check() {
  if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓${NC} $1"
    ((pass_count++))
  else
    echo -e "${RED}✗${NC} $1"
    ((fail_count++))
  fi
}

check_file() {
  if [ -f "$1" ]; then
    echo -e "${GREEN}✓${NC} $2"
    ((pass_count++))
  else
    echo -e "${RED}✗${NC} $2 - File not found: $1"
    ((fail_count++))
  fi
}

echo "1. Checking Core Files..."
echo "-----------------------------------"
check_file "app/components/styleguide/base_component.rb" "BaseComponent exists"
check_file "app/helpers/styleguide_helper.rb" "StyleguideHelper exists"
check_file "DESIGN_SYSTEM.md" "Design system documentation"
check_file "app/components/styleguide/MIGRATION_GUIDE.md" "Migration guide"
echo ""

echo "2. Checking Stimulus Controllers..."
echo "-----------------------------------"
check_file "app/javascript/controllers/tabs_controller.js" "Tabs controller"
check_file "app/javascript/controllers/accordion_controller.js" "Accordion controller"
check_file "app/javascript/controllers/dialog_controller.js" "Dialog controller"
check_file "app/javascript/controllers/switch_controller.js" "Switch controller"
echo ""

echo "3. Checking Component Inheritance..."
echo "-----------------------------------"
bad_inheritance=$(grep -l "< ViewComponent::Base" app/components/styleguide/*_component.rb 2>/dev/null | grep -v base_component || true)
if [ -z "$bad_inheritance" ]; then
  echo -e "${GREEN}✓${NC} All components inherit from BaseComponent"
  ((pass_count++))
else
  echo -e "${RED}✗${NC} Some components still inherit from ViewComponent::Base:"
  echo "$bad_inheritance"
  ((fail_count++))
fi
echo ""

echo "4. Checking for Old Class Pattern..."
echo "-----------------------------------"
old_pattern=$(grep -l "binding.local_variable_get" app/components/styleguide/*_component.rb 2>/dev/null || true)
if [ -z "$old_pattern" ]; then
  echo -e "${GREEN}✓${NC} No components use old class pattern"
  ((pass_count++))
else
  echo -e "${RED}✗${NC} Some components still use binding.local_variable_get:"
  echo "$old_pattern"
  ((fail_count++))
fi
echo ""

echo "5. Checking Component Count..."
echo "-----------------------------------"
component_count=$(ls app/components/styleguide/*_component.rb 2>/dev/null | grep -v base_component | wc -l)
echo -e "${GREEN}✓${NC} Found $component_count components"
((pass_count++))
echo ""

echo "6. Checking Test Files..."
echo "-----------------------------------"
test_count=$(ls spec/components/styleguide/*_spec.rb 2>/dev/null | wc -l)
if [ $test_count -gt 0 ]; then
  echo -e "${GREEN}✓${NC} Found $test_count test files"
  ((pass_count++))
else
  echo -e "${YELLOW}⚠${NC}  No test files found (recommended to add more)"
fi
echo ""

echo "7. Checking Preview Files..."
echo "-----------------------------------"
preview_count=$(find spec/components/previews/styleguide -name "*_preview.rb" 2>/dev/null | wc -l)
if [ $preview_count -gt 0 ]; then
  echo -e "${GREEN}✓${NC} Found $preview_count preview files"
  ((pass_count++))
else
  echo -e "${YELLOW}⚠${NC}  No preview files found (recommended for Lookbook)"
fi
echo ""

echo "========================================="
echo "  Summary"
echo "========================================="
echo -e "${GREEN}Passed:${NC} $pass_count"
if [ $fail_count -gt 0 ]; then
  echo -e "${RED}Failed:${NC} $fail_count"
  echo ""
  echo -e "${RED}❌ Verification FAILED${NC}"
  exit 1
else
  echo -e "${GREEN}Failed:${NC} 0"
  echo ""
  echo -e "${GREEN}✅ All checks passed!${NC}"
  echo ""
  echo "Design system is ready to use!"
  echo ""
  echo "Next steps:"
  echo "  1. Run bin/dev to start the server"
  echo "  2. Visit /styleguide to see components"
  echo "  3. Run bundle exec rspec spec/components/styleguide/ to test"
  echo "  4. Read DESIGN_SYSTEM.md for documentation"
  exit 0
fi
